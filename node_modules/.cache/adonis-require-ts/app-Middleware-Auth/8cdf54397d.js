"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const standalone_1 = require("@adonisjs/auth/build/standalone");
class AuthMiddleware {
    constructor() {
        this.redirectTo = '/login';
    }
    async authenticate(auth, guards) {
        let guardLastAttempted;
        for (let guard of guards) {
            guardLastAttempted = guard;
            if (await auth.use(guard).check()) {
                auth.defaultGuard = guard;
                return true;
            }
        }
        throw new standalone_1.AuthenticationException('Unauthorized access', 'E_UNAUTHORIZED_ACCESS', guardLastAttempted, this.redirectTo);
    }
    async handle({ auth }, next, customGuards) {
        const guards = customGuards.length ? customGuards : [auth.name];
        await this.authenticate(auth, guards);
        await next();
    }
}
exports.default = AuthMiddleware;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkF1dGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxnRUFBeUU7QUFXekUsTUFBcUIsY0FBYztJQUFuQztRQUlZLGVBQVUsR0FBRyxRQUFRLENBQUE7SUE0RGpDLENBQUM7SUFsRFcsS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFpQyxFQUFFLE1BQTRCO1FBTzFGLElBQUksa0JBQXNDLENBQUE7UUFFMUMsS0FBSyxJQUFJLEtBQUssSUFBSSxNQUFNLEVBQUU7WUFDeEIsa0JBQWtCLEdBQUcsS0FBSyxDQUFBO1lBRTFCLElBQUksTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO2dCQU1qQyxJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQTtnQkFDekIsT0FBTyxJQUFJLENBQUE7YUFDWjtTQUNGO1FBS0QsTUFBTSxJQUFJLG9DQUF1QixDQUMvQixxQkFBcUIsRUFDckIsdUJBQXVCLEVBQ3ZCLGtCQUFrQixFQUNsQixJQUFJLENBQUMsVUFBVSxDQUNoQixDQUFBO0lBQ0gsQ0FBQztJQUtNLEtBQUssQ0FBQyxNQUFNLENBQ2pCLEVBQUUsSUFBSSxFQUF1QixFQUM3QixJQUF5QixFQUN6QixZQUFrQztRQU1sQyxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQy9ELE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDckMsTUFBTSxJQUFJLEVBQUUsQ0FBQTtJQUNkLENBQUM7Q0FDRjtBQWhFRCxpQ0FnRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBdXRoZW50aWNhdGlvbkV4Y2VwdGlvbiB9IGZyb20gJ0BhZG9uaXNqcy9hdXRoL2J1aWxkL3N0YW5kYWxvbmUnXG5pbXBvcnQgdHlwZSB7IEd1YXJkc0xpc3QgfSBmcm9tICdAaW9jOkFkb25pcy9BZGRvbnMvQXV0aCdcbmltcG9ydCB0eXBlIHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5cbi8qKlxuICogQXV0aCBtaWRkbGV3YXJlIGlzIG1lYW50IHRvIHJlc3RyaWN0IHVuLWF1dGhlbnRpY2F0ZWQgYWNjZXNzIHRvIGEgZ2l2ZW4gcm91dGVcbiAqIG9yIGEgZ3JvdXAgb2Ygcm91dGVzLlxuICpcbiAqIFlvdSBtdXN0IHJlZ2lzdGVyIHRoaXMgbWlkZGxld2FyZSBpbnNpZGUgYHN0YXJ0L2tlcm5lbC50c2AgZmlsZSB1bmRlciB0aGUgbGlzdFxuICogb2YgbmFtZWQgbWlkZGxld2FyZS5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXV0aE1pZGRsZXdhcmUge1xuICAvKipcbiAgICogVGhlIFVSTCB0byByZWRpcmVjdCB0byB3aGVuIHJlcXVlc3QgaXMgVW5hdXRob3JpemVkXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVkaXJlY3RUbyA9ICcvbG9naW4nXG5cbiAgLyoqXG4gICAqIEF1dGhlbnRpY2F0ZXMgdGhlIGN1cnJlbnQgSFRUUCByZXF1ZXN0IGFnYWluc3QgYSBjdXN0b20gc2V0IG9mIGRlZmluZWRcbiAgICogZ3VhcmRzLlxuICAgKlxuICAgKiBUaGUgYXV0aGVudGljYXRpb24gbG9vcCBzdG9wcyBhcyBzb29uIGFzIHRoZSB1c2VyIGlzIGF1dGhlbnRpY2F0ZWQgdXNpbmcgYW55XG4gICAqIG9mIHRoZSBtZW50aW9uZWQgZ3VhcmRzIGFuZCB0aGF0IGd1YXJkIHdpbGwgYmUgdXNlZCBieSB0aGUgcmVzdCBvZiB0aGUgY29kZVxuICAgKiBkdXJpbmcgdGhlIGN1cnJlbnQgcmVxdWVzdC5cbiAgICovXG4gIHByb3RlY3RlZCBhc3luYyBhdXRoZW50aWNhdGUoYXV0aDogSHR0cENvbnRleHRDb250cmFjdFsnYXV0aCddLCBndWFyZHM6IChrZXlvZiBHdWFyZHNMaXN0KVtdKSB7XG4gICAgLyoqXG4gICAgICogSG9sZCByZWZlcmVuY2UgdG8gdGhlIGd1YXJkIGxhc3QgYXR0ZW1wdGVkIHdpdGhpbiB0aGUgZm9yIGxvb3AuIFdlIHBhc3NcbiAgICAgKiB0aGUgcmVmZXJlbmNlIG9mIHRoZSBndWFyZCB0byB0aGUgXCJBdXRoZW50aWNhdGlvbkV4Y2VwdGlvblwiLCBzbyB0aGF0XG4gICAgICogaXQgY2FuIGRlY2lkZSB0aGUgY29ycmVjdCByZXNwb25zZSBiZWhhdmlvciBiYXNlZCB1cG9uIHRoZSBndWFyZFxuICAgICAqIGRyaXZlclxuICAgICAqL1xuICAgIGxldCBndWFyZExhc3RBdHRlbXB0ZWQ6IHN0cmluZyB8IHVuZGVmaW5lZFxuXG4gICAgZm9yIChsZXQgZ3VhcmQgb2YgZ3VhcmRzKSB7XG4gICAgICBndWFyZExhc3RBdHRlbXB0ZWQgPSBndWFyZFxuXG4gICAgICBpZiAoYXdhaXQgYXV0aC51c2UoZ3VhcmQpLmNoZWNrKCkpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEluc3RydWN0IGF1dGggdG8gdXNlIHRoZSBnaXZlbiBndWFyZCBhcyB0aGUgZGVmYXVsdCBndWFyZCBmb3JcbiAgICAgICAgICogdGhlIHJlc3Qgb2YgdGhlIHJlcXVlc3QsIHNpbmNlIHRoZSB1c2VyIGF1dGhlbnRpY2F0ZWRcbiAgICAgICAgICogc3VjY2VlZGVkIGhlcmVcbiAgICAgICAgICovXG4gICAgICAgIGF1dGguZGVmYXVsdEd1YXJkID0gZ3VhcmRcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVbmFibGUgdG8gYXV0aGVudGljYXRlIHVzaW5nIGFueSBndWFyZFxuICAgICAqL1xuICAgIHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkV4Y2VwdGlvbihcbiAgICAgICdVbmF1dGhvcml6ZWQgYWNjZXNzJyxcbiAgICAgICdFX1VOQVVUSE9SSVpFRF9BQ0NFU1MnLFxuICAgICAgZ3VhcmRMYXN0QXR0ZW1wdGVkLFxuICAgICAgdGhpcy5yZWRpcmVjdFRvLFxuICAgIClcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgcmVxdWVzdFxuICAgKi9cbiAgcHVibGljIGFzeW5jIGhhbmRsZSAoXG4gICAgeyBhdXRoIH06IEh0dHBDb250ZXh0Q29udHJhY3QsXG4gICAgbmV4dDogKCkgPT4gUHJvbWlzZTx2b2lkPixcbiAgICBjdXN0b21HdWFyZHM6IChrZXlvZiBHdWFyZHNMaXN0KVtdXG4gICkge1xuICAgIC8qKlxuICAgICAqIFVzZXMgdGhlIHVzZXIgZGVmaW5lZCBndWFyZHMgb3IgdGhlIGRlZmF1bHQgZ3VhcmQgbWVudGlvbmVkIGluXG4gICAgICogdGhlIGNvbmZpZyBmaWxlXG4gICAgICovXG4gICAgY29uc3QgZ3VhcmRzID0gY3VzdG9tR3VhcmRzLmxlbmd0aCA/IGN1c3RvbUd1YXJkcyA6IFthdXRoLm5hbWVdXG4gICAgYXdhaXQgdGhpcy5hdXRoZW50aWNhdGUoYXV0aCwgZ3VhcmRzKVxuICAgIGF3YWl0IG5leHQoKVxuICB9XG59XG4iXX0=