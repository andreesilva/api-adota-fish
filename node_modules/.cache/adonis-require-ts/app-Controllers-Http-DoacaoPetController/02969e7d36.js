"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
const Cliente_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Cliente"));
const CreateDoacaoPetValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/CreateDoacaoPetValidator"));
const Pet_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Pet"));
const DoacaoPet_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/DoacaoPet"));
class DoacaoPetController {
    async store({ auth, response, request }) {
        const payload = await request.validate(CreateDoacaoPetValidator_1.default);
        const userAuth = await auth.use("api").authenticate();
        const cliente = await Cliente_1.default.findByOrFail("user_id", userAuth.id);
        const trx = await Database_1.default.transaction();
        try {
            const pet = await Pet_1.default.create({
                foto: payload.foto,
                especie_id: payload.especie_id,
                quantidade: payload.quantidade,
                observacao: payload.observacao
            });
            const doacao = await DoacaoPet_1.default.create({
                cliente_id_doador: cliente.id,
                pet_id: pet.id,
                status: 1
            });
            await trx.commit();
            return response.ok({
                id: doacao.id,
                cliente_id_doador: doacao.cliente_id_doador,
                status: doacao.status
            });
        }
        catch (error) {
            await trx.rollback();
            return response.badRequest("Something in the request is wrong" + error);
        }
    }
    async all({ response, params }) {
        const id = params.id;
        if (id == 0) {
            const doacoes = await DoacaoPet_1.default.query()
                .where("status", 1)
                .preload("cliente_doador", (addressQuery) => {
                addressQuery
                    .preload("usuario")
                    .preload("endereco", (cityQuery) => {
                    cityQuery
                        .preload("cidade", (stateQuery) => {
                        stateQuery
                            .preload("estado");
                    });
                });
            })
                .preload("pet", (petsQuery) => {
                petsQuery
                    .preload("especie");
            })
                .orderBy("created_at", "desc");
            return response.ok(doacoes);
        }
        else {
            const existRegister = await Database_1.default.rawQuery(`select doacao_pets.id, pets.foto, cidades.nome,estados.nome ,especies.nome
                from doacao_pets
                inner join pets on doacao_pets.pet_id = pets.id 
                inner join especies on pets.especie_id = especies.id 
                inner join clientes on doacao_pets.cliente_id_doador = clientes.id 
                inner join users on clientes.user_id = users.id 
                inner join enderecos on clientes.id = enderecos.cliente_id 
                inner join cidades on enderecos.cidade_id = cidades.id 
                inner join estados on cidades.estado_id = estados.id 
                where doacao_pets.status = :status and estados.id = :estado`, {
                status: 1,
                estado: id
            });
            const doacoes = await DoacaoPet_1.default.query()
                .where("status", 1)
                .preload("cliente_doador", (addressQuery) => {
                addressQuery
                    .preload("usuario")
                    .preload("endereco", (cityQuery) => {
                    cityQuery
                        .preload("cidade", (stateQuery) => {
                        stateQuery
                            .preload("estado", (stateIdQuery) => {
                            stateIdQuery.where('id', id);
                        });
                    });
                });
            })
                .preload("pet", (petsQuery) => {
                petsQuery
                    .preload("especie");
            })
                .orderBy("created_at", "desc");
            if (existRegister[0] == "") {
                return response.ok([]);
            }
            else {
                return response.ok(doacoes);
            }
        }
    }
    async index({ auth, response }) {
        const userAuth = await auth.use("api").authenticate();
        const cliente = await Cliente_1.default.findByOrFail("user_id", userAuth.id);
        const doacoes = await DoacaoPet_1.default.query()
            .where("cliente_id_doador", cliente.id)
            .where("status", 1)
            .orWhere("status", 2)
            .preload("cliente_doador", (addressQuery) => {
            addressQuery
                .preload("usuario")
                .preload("endereco", (cityQuery) => {
                cityQuery
                    .preload("cidade", (stateQuery) => {
                    stateQuery
                        .preload("estado");
                });
            });
        })
            .preload("pet", (petsQuery) => {
            petsQuery
                .preload("especie");
        })
            .orderBy("created_at", "desc");
        return response.ok(doacoes);
    }
    async show({ params, response }) {
        const idDoacao = params.id;
        const pedido = await DoacaoPet_1.default.query()
            .where("id", idDoacao)
            .preload("cliente_doador", (addressQuery) => {
            addressQuery
                .preload("usuario")
                .preload("endereco", (cityQuery) => {
                cityQuery
                    .preload("cidade", (stateQuery) => {
                    stateQuery
                        .preload("estado");
                });
            });
        })
            .preload("pet", (petsQuery) => {
            petsQuery
                .preload("especie");
        })
            .orderBy("id", "desc")
            .first();
        if (pedido == null) {
            return response.notFound("NÃ£o encontrado");
        }
        return response.ok(pedido);
    }
    async inactivate({ response, params }) {
        const id = params.id;
        try {
            const doacao = await DoacaoPet_1.default.findByOrFail("id", id);
            doacao.merge({
                status: 2
            });
            await doacao.save();
            return response.ok(true);
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
    async activate({ response, params }) {
        const id = params.id;
        try {
            const doacao = await DoacaoPet_1.default.findByOrFail("id", id);
            doacao.merge({
                status: 1
            });
            await doacao.save();
            return response.ok(true);
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
    async delete({ response, params }) {
        const id = params.id;
        try {
            const doacao = await DoacaoPet_1.default.findByOrFail("id", id);
            doacao.merge({
                status: 3
            });
            await doacao.save();
            return response.ok(true);
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
}
exports.default = DoacaoPetController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRG9hY2FvUGV0Q29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkRvYWNhb1BldENvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSwyRkFBa0Q7QUFDbEQsdUZBQXlDO0FBQ3pDLDZIQUE4RTtBQUM5RSwrRUFBaUM7QUFDakMsMkZBQTZDO0FBRTdDLE1BQXFCLG1CQUFtQjtJQUU3QixLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQXVCO1FBRS9ELE1BQU0sT0FBTyxHQUFHLE1BQU0sT0FBTyxDQUFDLFFBQVEsQ0FBQyxrQ0FBd0IsQ0FBQyxDQUFDO1FBRWpFLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0RCxNQUFNLE9BQU8sR0FBRyxNQUFNLGlCQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFbkUsTUFBTSxHQUFHLEdBQUcsTUFBTSxrQkFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXpDLElBQUc7WUFDSyxNQUFNLEdBQUcsR0FBRyxNQUFNLGFBQUcsQ0FBQyxNQUFNLENBQUM7Z0JBQ3pCLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSTtnQkFDbEIsVUFBVSxFQUFFLE9BQU8sQ0FBQyxVQUFVO2dCQUM5QixVQUFVLEVBQUUsT0FBTyxDQUFDLFVBQVU7Z0JBQzlCLFVBQVUsRUFBRSxPQUFPLENBQUMsVUFBVTthQUNqQyxDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLG1CQUFTLENBQUMsTUFBTSxDQUFDO2dCQUN0QyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsRUFBRTtnQkFDN0IsTUFBTSxFQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUNiLE1BQU0sRUFBRSxDQUFDO2FBQ1IsQ0FBQyxDQUFDO1lBRUgsTUFB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LENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRXRELE1BQU0sQ0FBQyxLQUFLLENBQUM7Z0JBQ1QsTUFBTSxFQUFFLENBQUM7YUFDWixDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUdwQixPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FFNUI7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNaLE9BQU8sUUFBUSxDQUFDLFVBQVUsQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1NBQ25FO0lBRUwsQ0FBQztDQUNKO0FBMU9ELHNDQTBPQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgRGF0YWJhc2UgZnJvbSAnQGlvYzpBZG9uaXMvTHVjaWQvRGF0YWJhc2UnO1xuaW1wb3J0IENsaWVudGUgZnJvbSAnQXBwL01vZGVscy9DbGllbnRlJztcbmltcG9ydCBDcmVhdGVBZG9jYW9QZXRWYWxpZGF0b3IgZnJvbSAnQXBwL1ZhbGlkYXRvcnMvQ3JlYXRlRG9hY2FvUGV0VmFsaWRhdG9yJ1xuaW1wb3J0IFBldCBmcm9tICdBcHAvTW9kZWxzL1BldCc7XG5pbXBvcnQgRG9hY2FvUGV0IGZyb20gJ0FwcC9Nb2RlbHMvRG9hY2FvUGV0JztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRG9hY2FvUGV0Q29udHJvbGxlciB7XG4gICAgXG4gICAgcHVibGljIGFzeW5jIHN0b3JlKHsgYXV0aCwgcmVzcG9uc2UsIHJlcXVlc3QgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuXG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKENyZWF0ZUFkb2Nhb1BldFZhbGlkYXRvcik7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB1c2VyQXV0aCA9IGF3YWl0IGF1dGgudXNlKFwiYXBpXCIpLmF1dGhlbnRpY2F0ZSgpO1xuICAgICAgICBjb25zdCBjbGllbnRlID0gYXdhaXQgQ2xpZW50ZS5maW5kQnlPckZhaWwoXCJ1c2VyX2lkXCIsIHVzZXJBdXRoLmlkKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgY29uc3QgdHJ4ID0gYXdhaXQgRGF0YWJhc2UudHJhbnNhY3Rpb24oKTtcbiAgICAgICAgXG4gICAgICAgIHRyeXtcbiAgICAgICAgICAgICAgICBjb25zdCBwZXQgPSBhd2FpdCBQZXQuY3JlYXRlKHtcbiAgICAgICAgICAgICAgICAgICAgZm90bzogcGF5bG9hZC5mb3RvLFxuICAgICAgICAgICAgICAgICAgICBlc3BlY2llX2lkOiBwYXlsb2FkLmVzcGVjaWVfaWQsXG4gICAgICAgICAgICAgICAgICAgIHF1YW50aWRhZGU6IHBheWxvYWQucXVhbnRpZGFkZSxcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2YWNhbzogcGF5bG9hZC5vYnNlcnZhY2FvXG4gICAgICAgICAgICAgICAgfSk7ICBcblxuICAgICAgICAgICAgICAgIGNvbnN0IGRvYWNhbyA9IGF3YWl0IERvYWNhb1BldC5jcmVhdGUoe1xuICAgICAgICAgICAgICAgIGNsaWVudGVfaWRfZG9hZG9yOiBjbGllbnRlLmlkLFxuICAgICAgICAgICAgICAgIHBldF9pZDpwZXQuaWQsIFxuICAgICAgICAgICAgICAgIHN0YXR1czogMVxuICAgICAgICAgICAgICAgIH0pO1xuICAgIFxuICAgICAgICAgICAgICAgIGF3YWl0IHRyeC5jb21taXQoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uub2soe1xuICAgICAgICAgICAgICAgICAgICBpZDogZG9hY2FvLmlkLFxuICAgICAgICAgICAgICAgICAgICBjbGllbnRlX2lkX2RvYWRvcjogZG9hY2FvLmNsaWVudGVfaWRfZG9hZG9yLFxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IGRvYWNhby5zdGF0dXNcbiAgICAgICAgICAgICAgICB9KTsgICBcbiAgICAgICAgfVxuICAgICAgICBjYXRjaChlcnJvcil7XG4gICAgICAgICAgICBhd2FpdCB0cngucm9sbGJhY2soKTtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KFwiU29tZXRoaW5nIGluIHRoZSByZXF1ZXN0IGlzIHdyb25nXCIgKyBlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIGFzeW5jIGFsbCh7IHJlc3BvbnNlLCBwYXJhbXMgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuXG4gICAgICAgIGNvbnN0IGlkID0gcGFyYW1zLmlkO1xuXG4gICAgICAgIGlmKGlkID09IDApe1xuICAgICAgICAgICAgY29uc3QgZG9hY29lcyA9IGF3YWl0IERvYWNhb1BldC5xdWVyeSgpXG4gICAgICAgICAgICAud2hlcmUoXCJzdGF0dXNcIiwgMSlcbiAgICAgICAgICAgIC5wcmVsb2FkKFwiY2xpZW50ZV9kb2Fkb3JcIiwoYWRkcmVzc1F1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgYWRkcmVzc1F1ZXJ5XG4gICAgICAgICAgICAgICAgLnByZWxvYWQoXCJ1c3VhcmlvXCIpXG4gICAgICAgICAgICAgICAgLnByZWxvYWQoXCJlbmRlcmVjb1wiLChjaXR5UXVlcnkpPT57XG4gICAgICAgICAgICAgICAgICAgIGNpdHlRdWVyeVxuICAgICAgICAgICAgICAgICAgICAucHJlbG9hZChcImNpZGFkZVwiLChzdGF0ZVF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVF1ZXJ5XG4gICAgICAgICAgICAgICAgICAgICAgICAucHJlbG9hZChcImVzdGFkb1wiKVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnByZWxvYWQoXCJwZXRcIiwgKHBldHNRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHBldHNRdWVyeVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZXNwZWNpZVwiKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vcmRlckJ5KFwiY3JlYXRlZF9hdFwiLCBcImRlc2NcIik7XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKGRvYWNvZXMpO1xuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0UmVnaXN0ZXIgPSBhd2FpdCBEYXRhYmFzZS5yYXdRdWVyeShcbiAgICAgICAgICAgICAgICBgc2VsZWN0IGRvYWNhb19wZXRzLmlkLCBwZXRzLmZvdG8sIGNpZGFkZXMubm9tZSxlc3RhZG9zLm5vbWUgLGVzcGVjaWVzLm5vbWVcbiAgICAgICAgICAgICAgICBmcm9tIGRvYWNhb19wZXRzXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiBwZXRzIG9uIGRvYWNhb19wZXRzLnBldF9pZCA9IHBldHMuaWQgXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiBlc3BlY2llcyBvbiBwZXRzLmVzcGVjaWVfaWQgPSBlc3BlY2llcy5pZCBcbiAgICAgICAgICAgICAgICBpbm5lciBqb2luIGNsaWVudGVzIG9uIGRvYWNhb19wZXRzLmNsaWVudGVfaWRfZG9hZG9yID0gY2xpZW50ZXMuaWQgXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiB1c2VycyBvbiBjbGllbnRlcy51c2VyX2lkID0gdXNlcnMuaWQgXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiBlbmRlcmVjb3Mgb24gY2xpZW50ZXMuaWQgPSBlbmRlcmVjb3MuY2xpZW50ZV9pZCBcbiAgICAgICAgICAgICAgICBpbm5lciBqb2luIGNpZGFkZXMgb24gZW5kZXJlY29zLmNpZGFkZV9pZCA9IGNpZGFkZXMuaWQgXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiBlc3RhZG9zIG9uIGNpZGFkZXMuZXN0YWRvX2lkID0gZXN0YWRvcy5pZCBcbiAgICAgICAgICAgICAgICB3aGVyZSBkb2FjYW9fcGV0cy5zdGF0dXMgPSA6c3RhdHVzIGFuZCBlc3RhZG9zLmlkID0gOmVzdGFkb2AsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgc3RhdHVzOiAxLFxuICAgICAgICAgICAgICAgICAgZXN0YWRvOmlkXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICApXG5cbiAgICAgICAgICAgIGNvbnN0IGRvYWNvZXMgPSBhd2FpdCBEb2FjYW9QZXQucXVlcnkoKVxuICAgICAgICAgICAgLndoZXJlKFwic3RhdHVzXCIsIDEpXG4gICAgICAgICAgICAucHJlbG9hZChcImNsaWVudGVfZG9hZG9yXCIsKGFkZHJlc3NRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIGFkZHJlc3NRdWVyeVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwidXN1YXJpb1wiKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZW5kZXJlY29cIiwoY2l0eVF1ZXJ5KT0+e1xuICAgICAgICAgICAgICAgICAgICBjaXR5UXVlcnlcbiAgICAgICAgICAgICAgICAgICAgLnByZWxvYWQoXCJjaWRhZGVcIiwoc3RhdGVRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVRdWVyeVxuICAgICAgICAgICAgICAgICAgICAgICAgLnByZWxvYWQoXCJlc3RhZG9cIiwoc3RhdGVJZFF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVJZFF1ZXJ5LndoZXJlKCdpZCcsIGlkKVxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnByZWxvYWQoXCJwZXRcIiwgKHBldHNRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHBldHNRdWVyeVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZXNwZWNpZVwiKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vcmRlckJ5KFwiY3JlYXRlZF9hdFwiLCBcImRlc2NcIik7XG5cbiAgICAgICAgICAgIGlmKGV4aXN0UmVnaXN0ZXJbMF0gPT0gXCJcIil7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKFtdKTtcbiAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKGRvYWNvZXMpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICBcbiAgICBwdWJsaWMgYXN5bmMgaW5kZXgoeyBhdXRoLCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICAgIGNvbnN0IHVzZXJBdXRoID0gYXdhaXQgYXV0aC51c2UoXCJhcGlcIikuYXV0aGVudGljYXRlKCk7XG4gICAgICAgIGNvbnN0IGNsaWVudGUgPSBhd2FpdCBDbGllbnRlLmZpbmRCeU9yRmFpbChcInVzZXJfaWRcIiwgdXNlckF1dGguaWQpO1xuXG4gICAgICAgIGNvbnN0IGRvYWNvZXMgPSBhd2FpdCBEb2FjYW9QZXQucXVlcnkoKVxuICAgICAgICAgICAgLndoZXJlKFwiY2xpZW50ZV9pZF9kb2Fkb3JcIiwgY2xpZW50ZS5pZClcbiAgICAgICAgICAgIC53aGVyZShcInN0YXR1c1wiLCAxKVxuICAgICAgICAgICAgLm9yV2hlcmUoXCJzdGF0dXNcIiwgMilcbiAgICAgICAgICAgIC5wcmVsb2FkKFwiY2xpZW50ZV9kb2Fkb3JcIiwoYWRkcmVzc1F1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgYWRkcmVzc1F1ZXJ5XG4gICAgICAgICAgICAgICAgLnByZWxvYWQoXCJ1c3VhcmlvXCIpXG4gICAgICAgICAgICAgICAgLnByZWxvYWQoXCJlbmRlcmVjb1wiLChjaXR5UXVlcnkpPT57XG4gICAgICAgICAgICAgICAgICAgIGNpdHlRdWVyeVxuICAgICAgICAgICAgICAgICAgICAucHJlbG9hZChcImNpZGFkZVwiLChzdGF0ZVF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVF1ZXJ5XG4gICAgICAgICAgICAgICAgICAgICAgICAucHJlbG9hZChcImVzdGFkb1wiKVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnByZWxvYWQoXCJwZXRcIiwgKHBldHNRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHBldHNRdWVyeVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZXNwZWNpZVwiKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vcmRlckJ5KFwiY3JlYXRlZF9hdFwiLCBcImRlc2NcIik7XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKGRvYWNvZXMpO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgc2hvdyh7IHBhcmFtcywgcmVzcG9uc2UgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgICAgICBjb25zdCBpZERvYWNhbyA9IHBhcmFtcy5pZDtcblxuICAgICAgICBjb25zdCBwZWRpZG8gPSBhd2FpdCBEb2FjYW9QZXQucXVlcnkoKVxuICAgICAgICAgICAgLndoZXJlKFwiaWRcIiwgaWREb2FjYW8pXG4gICAgICAgICAgICAucHJlbG9hZChcImNsaWVudGVfZG9hZG9yXCIsKGFkZHJlc3NRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIGFkZHJlc3NRdWVyeVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwidXN1YXJpb1wiKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZW5kZXJlY29cIiwoY2l0eVF1ZXJ5KT0+e1xuICAgICAgICAgICAgICAgICAgICBjaXR5UXVlcnlcbiAgICAgICAgICAgICAgICAgICAgLnByZWxvYWQoXCJjaWRhZGVcIiwoc3RhdGVRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVRdWVyeVxuICAgICAgICAgICAgICAgICAgICAgICAgLnByZWxvYWQoXCJlc3RhZG9cIilcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5wcmVsb2FkKFwicGV0XCIsIChwZXRzUXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICBwZXRzUXVlcnlcbiAgICAgICAgICAgICAgICAucHJlbG9hZChcImVzcGVjaWVcIilcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub3JkZXJCeShcImlkXCIsIFwiZGVzY1wiKVxuICAgICAgICAgICAgLmZpcnN0KCk7XG5cbiAgICAgICAgaWYgKHBlZGlkbyA9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uubm90Rm91bmQoXCJOw6NvIGVuY29udHJhZG9cIik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHBlZGlkbyk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGluYWN0aXZhdGUoeyByZXNwb25zZSAscGFyYW1zfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgICAgXG4gICAgICAgIGNvbnN0IGlkID0gcGFyYW1zLmlkO1xuXG4gICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGRvYWNhbyA9IGF3YWl0IERvYWNhb1BldC5maW5kQnlPckZhaWwoXCJpZFwiLCBpZCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGRvYWNhby5tZXJnZSh7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiAyXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXdhaXQgZG9hY2FvLnNhdmUoKTtcblxuXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uub2sodHJ1ZSk7XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KFwiU29tZXRoaW5nIGluIHRoZSByZXF1ZXN0IGlzIHdyb25nXCIpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgYWN0aXZhdGUoeyByZXNwb25zZSAscGFyYW1zfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgICAgXG4gICAgICAgIGNvbnN0IGlkID0gcGFyYW1zLmlkO1xuXG4gICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGRvYWNhbyA9IGF3YWl0IERvYWNhb1BldC5maW5kQnlPckZhaWwoXCJpZFwiLCBpZCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGRvYWNhby5tZXJnZSh7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiAxXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXdhaXQgZG9hY2FvLnNhdmUoKTtcblxuXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uub2sodHJ1ZSk7XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KFwiU29tZXRoaW5nIGluIHRoZSByZXF1ZXN0IGlzIHdyb25nXCIpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZGVsZXRlKHsgcmVzcG9uc2UgLHBhcmFtc306IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICAgIFxuICAgICAgICBjb25zdCBpZCA9IHBhcmFtcy5pZDtcblxuICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICBjb25zdCBkb2FjYW8gPSBhd2FpdCBEb2FjYW9QZXQuZmluZEJ5T3JGYWlsKFwiaWRcIiwgaWQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBkb2FjYW8ubWVyZ2Uoe1xuICAgICAgICAgICAgICAgIHN0YXR1czogM1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IGRvYWNhby5zYXZlKCk7XG5cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHRydWUpO1xuXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuYmFkUmVxdWVzdChcIlNvbWV0aGluZyBpbiB0aGUgcmVxdWVzdCBpcyB3cm9uZ1wiKTtcbiAgICAgICAgfVxuXG4gICAgfVxufVxuIl19