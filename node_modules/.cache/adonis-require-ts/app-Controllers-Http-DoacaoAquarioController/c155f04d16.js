"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
const Cliente_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Cliente"));
const CreateDoacaoAquarioValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/CreateDoacaoAquarioValidator"));
const Aquario_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Aquario"));
const DoacaoAquario_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/DoacaoAquario"));
class DoacaoAquarioController {
    async store({ auth, response, request }) {
        const payload = await request.validate(CreateDoacaoAquarioValidator_1.default);
        const userAuth = await auth.use("api").authenticate();
        const cliente = await Cliente_1.default.findByOrFail("user_id", userAuth.id);
        const trx = await Database_1.default.transaction();
        try {
            const aquario = await Aquario_1.default.create({
                foto: payload.foto,
                capacidade: payload.capacidade,
                descricao: payload.descricao
            });
            const doacao = await DoacaoAquario_1.default.create({
                cliente_id_doador: cliente.id,
                aquario_id: aquario.id,
                status: 1
            });
            await trx.commit();
            return response.ok({
                id: doacao.id,
                cliente_id_doador: doacao.cliente_id_doador,
                status: doacao.status
            });
        }
        catch (error) {
            await trx.rollback();
            return response.badRequest("Something in the request is wrong" + error);
        }
    }
    async all({ response, params }) {
        const id = params.id;
        if (id == 0) {
            const doacoes = await DoacaoAquario_1.default.query()
                .where("status", 1)
                .preload("cliente_doador", (addressQuery) => {
                addressQuery
                    .preload("usuario")
                    .preload("endereco", (cityQuery) => {
                    cityQuery
                        .preload("cidade", (stateQuery) => {
                        stateQuery
                            .preload("estado");
                    });
                });
            })
                .preload("aquario")
                .orderBy("created_at", "desc");
            return response.ok(doacoes);
        }
        else {
            const existRegister = await Database_1.default.rawQuery(`select doacao_aquarios.id,aquarios.foto,aquarios.capacidade,cidades.nome,estados.nome 
                from doacao_aquarios 
                inner join aquarios on doacao_aquarios.aquario_id = aquarios.id 
                inner join clientes on doacao_aquarios.cliente_id_doador = clientes.id 
                inner join users on clientes.user_id = users.id 
                inner join enderecos on clientes.id = enderecos.cliente_id 
                inner join cidades on enderecos.cidade_id = cidades.id 
                inner join estados on cidades.estado_id = estados.id 
                where doacao_aquarios.status = :status and estados.id = :estado`, {
                status: 1,
                estado: id
            });
            const doacoes = await DoacaoAquario_1.default.query()
                .preload("cliente_doador", (addressQuery) => {
                addressQuery
                    .preload("usuario")
                    .preload("endereco", (cityQuery) => {
                    cityQuery
                        .preload("cidade", (stateQuery) => {
                        stateQuery
                            .preload("estado", (stateIdQuery) => {
                            stateIdQuery
                                .where("created_at", id);
                        });
                    });
                });
            })
                .preload("aquario")
                .where("status", 1)
                .orderBy("id", "desc");
            if (existRegister[0] == "") {
                return response.ok([]);
            }
            else {
                return response.ok(doacoes);
            }
        }
    }
    async index({ auth, response }) {
        const userAuth = await auth.use("api").authenticate();
        const cliente = await Cliente_1.default.findByOrFail("user_id", userAuth.id);
        const doacoes = await DoacaoAquario_1.default.query()
            .where("cliente_id_doador", cliente.id)
            .where("status", 1)
            .orWhere("status", 2)
            .preload("cliente_doador", (addressQuery) => {
            addressQuery
                .preload("usuario")
                .preload("endereco", (cityQuery) => {
                cityQuery
                    .preload("cidade", (stateQuery) => {
                    stateQuery
                        .preload("estado");
                });
            });
        })
            .preload("aquario")
            .orderBy("created_at", "desc");
        return response.ok(doacoes);
    }
    async show({ params, response }) {
        const idDoacao = params.id;
        const pedido = await DoacaoAquario_1.default.query()
            .where("id", idDoacao)
            .preload("cliente_doador", (addressQuery) => {
            addressQuery
                .preload("usuario")
                .preload("endereco", (cityQuery) => {
                cityQuery
                    .preload("cidade", (stateQuery) => {
                    stateQuery
                        .preload("estado");
                });
            });
        })
            .preload("aquario")
            .orderBy("id", "desc")
            .first();
        if (pedido == null) {
            return response.notFound("NÃ£o encontrado");
        }
        return response.ok(pedido);
    }
    async inactivate({ response, params }) {
        const id = params.id;
        try {
            const doacao = await DoacaoAquario_1.default.findByOrFail("id", id);
            doacao.merge({
                status: 2
            });
            await doacao.save();
            return response.ok(true);
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
    async activate({ response, params }) {
        const id = params.id;
        try {
            const doacao = await DoacaoAquario_1.default.findByOrFail("id", id);
            doacao.merge({
                status: 1
            });
            await doacao.save();
            return response.ok(true);
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
    async delete({ response, params }) {
        const id = params.id;
        try {
            const doacao = await DoacaoAquario_1.default.findByOrFail("id", id);
            doacao.merge({
                status: 3
            });
            await doacao.save();
            return response.ok(true);
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
}
exports.default = DoacaoAquarioController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRG9hY2FvQXF1YXJpb0NvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJEb2FjYW9BcXVhcmlvQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLDJGQUFrRDtBQUNsRCx1RkFBeUM7QUFDekMscUlBQXNGO0FBQ3RGLHVGQUF5QztBQUN6QyxtR0FBcUQ7QUFFckQsTUFBcUIsdUJBQXVCO0lBRWpDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBdUI7UUFFL0QsTUFBTSxPQUFPLEdBQUcsTUFBTSxPQUFPLENBQUMsUUFBUSxDQUFDLHNDQUE0QixDQUFDLENBQUM7UUFFckUsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RELE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVuRSxNQUFNLEdBQUcsR0FBRyxNQUFNLGtCQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFekMsSUFBRztZQUNLLE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxNQUFNLENBQUM7Z0JBQ2pDLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSTtnQkFDbEIsVUFBVSxFQUFDLE9BQU8sQ0FBQyxVQUFVO2dCQUM3QixTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVM7YUFFL0IsQ0FBQyxDQUFDO1lBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSx1QkFBYSxDQUFDLE1BQU0sQ0FBQztnQkFDMUMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLEVBQUU7Z0JBQzdCLFVBQVUsRUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDckIsTUFBTSxFQUFFLENBQUM7YUFDUixDQUFDLENBQUM7WUFFSCxNQUFNLEdBQUcsQ0FBQyxNQUFNLEVBQUUs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Y3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0J1xuaW1wb3J0IERhdGFiYXNlIGZyb20gJ0Bpb2M6QWRvbmlzL0x1Y2lkL0RhdGFiYXNlJztcbmltcG9ydCBDbGllbnRlIGZyb20gJ0FwcC9Nb2RlbHMvQ2xpZW50ZSc7XG5pbXBvcnQgQ3JlYXRlQWRvY2FvQXF1YXJpb1ZhbGlkYXRvciBmcm9tICdBcHAvVmFsaWRhdG9ycy9DcmVhdGVEb2FjYW9BcXVhcmlvVmFsaWRhdG9yJ1xuaW1wb3J0IEFxdWFyaW8gZnJvbSAnQXBwL01vZGVscy9BcXVhcmlvJztcbmltcG9ydCBEb2FjYW9BcXVhcmlvIGZyb20gJ0FwcC9Nb2RlbHMvRG9hY2FvQXF1YXJpbyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERvYWNhb0FxdWFyaW9Db250cm9sbGVyIHtcbiAgICBcbiAgICBwdWJsaWMgYXN5bmMgc3RvcmUoeyBhdXRoLCByZXNwb25zZSwgcmVxdWVzdCB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG5cbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IHJlcXVlc3QudmFsaWRhdGUoQ3JlYXRlQWRvY2FvQXF1YXJpb1ZhbGlkYXRvcik7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB1c2VyQXV0aCA9IGF3YWl0IGF1dGgudXNlKFwiYXBpXCIpLmF1dGhlbnRpY2F0ZSgpO1xuICAgICAgICBjb25zdCBjbGllbnRlID0gYXdhaXQgQ2xpZW50ZS5maW5kQnlPckZhaWwoXCJ1c2VyX2lkXCIsIHVzZXJBdXRoLmlkKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgY29uc3QgdHJ4ID0gYXdhaXQgRGF0YWJhc2UudHJhbnNhY3Rpb24oKTtcbiAgICAgICBcbiAgICAgICAgdHJ5eyAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnN0IGFxdWFyaW8gPSBhd2FpdCBBcXVhcmlvLmNyZWF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIGZvdG86IHBheWxvYWQuZm90byxcbiAgICAgICAgICAgICAgICAgICAgY2FwYWNpZGFkZTpwYXlsb2FkLmNhcGFjaWRhZGUsXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaWNhbzogcGF5bG9hZC5kZXNjcmljYW9cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7ICBcblxuICAgICAgICAgICAgICAgIGNvbnN0IGRvYWNhbyA9IGF3YWl0IERvYWNhb0FxdWFyaW8uY3JlYXRlKHtcbiAgICAgICAgICAgICAgICBjbGllbnRlX2lkX2RvYWRvcjogY2xpZW50ZS5pZCxcbiAgICAgICAgICAgICAgICBhcXVhcmlvX2lkOmFxdWFyaW8uaWQsIFxuICAgICAgICAgICAgICAgIHN0YXR1czogMVxuICAgICAgICAgICAgICAgIH0pO1xuICAgIFxuICAgICAgICAgICAgICAgIGF3YWl0IHRyeC5jb21taXQoKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayh7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBkb2FjYW8uaWQsXG4gICAgICAgICAgICAgICAgICAgIGNsaWVudGVfaWRfZG9hZG9yOiBkb2FjYW8uY2xpZW50ZV9pZF9kb2Fkb3IsXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogZG9hY2FvLnN0YXR1c1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoKGVycm9yKXtcbiAgICAgICAgICAgIGF3YWl0IHRyeC5yb2xsYmFjaygpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoXCJTb21ldGhpbmcgaW4gdGhlIHJlcXVlc3QgaXMgd3JvbmdcIiArIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBhbGwoeyByZXNwb25zZSwgcGFyYW1zIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcblxuICAgICAgICBjb25zdCBpZCA9IHBhcmFtcy5pZDtcblxuICAgICAgICBpZihpZCA9PSAwKXtcbiAgICAgICAgICAgIGNvbnN0IGRvYWNvZXMgPSBhd2FpdCBEb2FjYW9BcXVhcmlvLnF1ZXJ5KClcbiAgICAgICAgICAgIC53aGVyZShcInN0YXR1c1wiLCAxKVxuICAgICAgICAgICAgLnByZWxvYWQoXCJjbGllbnRlX2RvYWRvclwiLChhZGRyZXNzUXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzUXVlcnlcbiAgICAgICAgICAgICAgICAucHJlbG9hZChcInVzdWFyaW9cIilcbiAgICAgICAgICAgICAgICAucHJlbG9hZChcImVuZGVyZWNvXCIsKGNpdHlRdWVyeSk9PntcbiAgICAgICAgICAgICAgICAgICAgY2l0eVF1ZXJ5XG4gICAgICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiY2lkYWRlXCIsKHN0YXRlUXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlUXVlcnlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZXN0YWRvXCIpXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAucHJlbG9hZChcImFxdWFyaW9cIilcbiAgICAgICAgICAgIC5vcmRlckJ5KFwiY3JlYXRlZF9hdFwiLCBcImRlc2NcIik7XG5cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayhkb2Fjb2VzKTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICBjb25zdCBleGlzdFJlZ2lzdGVyID0gYXdhaXQgRGF0YWJhc2UucmF3UXVlcnkoXG4gICAgICAgICAgICAgICAgYHNlbGVjdCBkb2FjYW9fYXF1YXJpb3MuaWQsYXF1YXJpb3MuZm90byxhcXVhcmlvcy5jYXBhY2lkYWRlLGNpZGFkZXMubm9tZSxlc3RhZG9zLm5vbWUgXG4gICAgICAgICAgICAgICAgZnJvbSBkb2FjYW9fYXF1YXJpb3MgXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiBhcXVhcmlvcyBvbiBkb2FjYW9fYXF1YXJpb3MuYXF1YXJpb19pZCA9IGFxdWFyaW9zLmlkIFxuICAgICAgICAgICAgICAgIGlubmVyIGpvaW4gY2xpZW50ZXMgb24gZG9hY2FvX2FxdWFyaW9zLmNsaWVudGVfaWRfZG9hZG9yID0gY2xpZW50ZXMuaWQgXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiB1c2VycyBvbiBjbGllbnRlcy51c2VyX2lkID0gdXNlcnMuaWQgXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiBlbmRlcmVjb3Mgb24gY2xpZW50ZXMuaWQgPSBlbmRlcmVjb3MuY2xpZW50ZV9pZCBcbiAgICAgICAgICAgICAgICBpbm5lciBqb2luIGNpZGFkZXMgb24gZW5kZXJlY29zLmNpZGFkZV9pZCA9IGNpZGFkZXMuaWQgXG4gICAgICAgICAgICAgICAgaW5uZXIgam9pbiBlc3RhZG9zIG9uIGNpZGFkZXMuZXN0YWRvX2lkID0gZXN0YWRvcy5pZCBcbiAgICAgICAgICAgICAgICB3aGVyZSBkb2FjYW9fYXF1YXJpb3Muc3RhdHVzID0gOnN0YXR1cyBhbmQgZXN0YWRvcy5pZCA9IDplc3RhZG9gLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHN0YXR1czogMSxcbiAgICAgICAgICAgICAgICAgIGVzdGFkbzppZFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgKVxuICAgIFxuICAgICAgICAgICAgICBjb25zdCBkb2Fjb2VzID0gYXdhaXQgRG9hY2FvQXF1YXJpby5xdWVyeSgpICAgICBcbiAgICAgICAgICAgICAgLnByZWxvYWQoXCJjbGllbnRlX2RvYWRvclwiLChhZGRyZXNzUXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzUXVlcnlcbiAgICAgICAgICAgICAgICAucHJlbG9hZChcInVzdWFyaW9cIilcbiAgICAgICAgICAgICAgICAucHJlbG9hZChcImVuZGVyZWNvXCIsKGNpdHlRdWVyeSk9PntcbiAgICAgICAgICAgICAgICAgICAgY2l0eVF1ZXJ5XG4gICAgICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiY2lkYWRlXCIsKHN0YXRlUXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlUXVlcnlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZXN0YWRvXCIsKHN0YXRlSWRRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlSWRRdWVyeVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC53aGVyZShcImNyZWF0ZWRfYXRcIixpZClcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAucHJlbG9hZChcImFxdWFyaW9cIilcbiAgICAgICAgICAgIC53aGVyZShcInN0YXR1c1wiLDEpXG4gICAgICAgICAgICAub3JkZXJCeShcImlkXCIsIFwiZGVzY1wiKVxuXG4gICAgICAgICAgICBpZihleGlzdFJlZ2lzdGVyWzBdID09IFwiXCIpe1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayhbXSk7XG4gICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayhkb2Fjb2VzKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgXG4gICAgcHVibGljIGFzeW5jIGluZGV4KHsgYXV0aCwgcmVzcG9uc2UgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgICAgICBjb25zdCB1c2VyQXV0aCA9IGF3YWl0IGF1dGgudXNlKFwiYXBpXCIpLmF1dGhlbnRpY2F0ZSgpO1xuICAgICAgICBjb25zdCBjbGllbnRlID0gYXdhaXQgQ2xpZW50ZS5maW5kQnlPckZhaWwoXCJ1c2VyX2lkXCIsIHVzZXJBdXRoLmlkKTtcblxuXG4gICAgICAgIGNvbnN0IGRvYWNvZXMgPSBhd2FpdCBEb2FjYW9BcXVhcmlvLnF1ZXJ5KClcbiAgICAgICAgICAgIC53aGVyZShcImNsaWVudGVfaWRfZG9hZG9yXCIsIGNsaWVudGUuaWQpXG4gICAgICAgICAgICAud2hlcmUoXCJzdGF0dXNcIiwgMSlcbiAgICAgICAgICAgIC5vcldoZXJlKFwic3RhdHVzXCIsIDIpXG4gICAgICAgICAgICAucHJlbG9hZChcImNsaWVudGVfZG9hZG9yXCIsKGFkZHJlc3NRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIGFkZHJlc3NRdWVyeVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwidXN1YXJpb1wiKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZW5kZXJlY29cIiwoY2l0eVF1ZXJ5KT0+e1xuICAgICAgICAgICAgICAgICAgICBjaXR5UXVlcnlcbiAgICAgICAgICAgICAgICAgICAgLnByZWxvYWQoXCJjaWRhZGVcIiwoc3RhdGVRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVRdWVyeVxuICAgICAgICAgICAgICAgICAgICAgICAgLnByZWxvYWQoXCJlc3RhZG9cIilcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5wcmVsb2FkKFwiYXF1YXJpb1wiKVxuICAgICAgICAgICAgLm9yZGVyQnkoXCJjcmVhdGVkX2F0XCIsIFwiZGVzY1wiKTtcblxuICAgICAgICByZXR1cm4gcmVzcG9uc2Uub2soZG9hY29lcyk7XG4gICAgfVxuICAgIFxuICAgIHB1YmxpYyBhc3luYyBzaG93KHsgcGFyYW1zLCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICAgIGNvbnN0IGlkRG9hY2FvID0gcGFyYW1zLmlkO1xuXG4gICAgICAgIGNvbnN0IHBlZGlkbyA9IGF3YWl0IERvYWNhb0FxdWFyaW8ucXVlcnkoKVxuICAgICAgICAgICAgLndoZXJlKFwiaWRcIiwgaWREb2FjYW8pXG4gICAgICAgICAgICAucHJlbG9hZChcImNsaWVudGVfZG9hZG9yXCIsKGFkZHJlc3NRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIGFkZHJlc3NRdWVyeVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwidXN1YXJpb1wiKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZW5kZXJlY29cIiwoY2l0eVF1ZXJ5KT0+e1xuICAgICAgICAgICAgICAgICAgICBjaXR5UXVlcnlcbiAgICAgICAgICAgICAgICAgICAgLnByZWxvYWQoXCJjaWRhZGVcIiwoc3RhdGVRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVRdWVyeVxuICAgICAgICAgICAgICAgICAgICAgICAgLnByZWxvYWQoXCJlc3RhZG9cIilcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5wcmVsb2FkKFwiYXF1YXJpb1wiKVxuICAgICAgICAgICAgLm9yZGVyQnkoXCJpZFwiLCBcImRlc2NcIilcbiAgICAgICAgICAgIC5maXJzdCgpO1xuXG4gICAgICAgIGlmIChwZWRpZG8gPT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm5vdEZvdW5kKFwiTsOjbyBlbmNvbnRyYWRvXCIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwb25zZS5vayhwZWRpZG8pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBpbmFjdGl2YXRlKHsgcmVzcG9uc2UgLHBhcmFtc306IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICAgIFxuICAgICAgICBjb25zdCBpZCA9IHBhcmFtcy5pZDtcblxuICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICBjb25zdCBkb2FjYW8gPSBhd2FpdCBEb2FjYW9BcXVhcmlvLmZpbmRCeU9yRmFpbChcImlkXCIsIGlkKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZG9hY2FvLm1lcmdlKHtcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDJcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBhd2FpdCBkb2FjYW8uc2F2ZSgpO1xuXG5cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayh0cnVlKTtcblxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoXCJTb21ldGhpbmcgaW4gdGhlIHJlcXVlc3QgaXMgd3JvbmdcIik7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBhY3RpdmF0ZSh7IHJlc3BvbnNlICxwYXJhbXN9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICBcbiAgICAgICAgY29uc3QgaWQgPSBwYXJhbXMuaWQ7XG5cbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgY29uc3QgZG9hY2FvID0gYXdhaXQgRG9hY2FvQXF1YXJpby5maW5kQnlPckZhaWwoXCJpZFwiLCBpZCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGRvYWNhby5tZXJnZSh7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiAxXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXdhaXQgZG9hY2FvLnNhdmUoKTtcblxuXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uub2sodHJ1ZSk7XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KFwiU29tZXRoaW5nIGluIHRoZSByZXF1ZXN0IGlzIHdyb25nXCIpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZGVsZXRlKHsgcmVzcG9uc2UgLHBhcmFtc306IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICAgIFxuICAgICAgICBjb25zdCBpZCA9IHBhcmFtcy5pZDtcblxuICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICBjb25zdCBkb2FjYW8gPSBhd2FpdCBEb2FjYW9BcXVhcmlvLmZpbmRCeU9yRmFpbChcImlkXCIsIGlkKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZG9hY2FvLm1lcmdlKHtcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDNcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBhd2FpdCBkb2FjYW8uc2F2ZSgpO1xuXG5cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayh0cnVlKTtcblxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoXCJTb21ldGhpbmcgaW4gdGhlIHJlcXVlc3QgaXMgd3JvbmdcIik7XG4gICAgICAgIH1cblxuICAgIH0gICBcbn0iXX0=