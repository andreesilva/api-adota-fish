"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
const Cliente_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Cliente"));
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const CreateClienteValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/CreateClienteValidator"));
const EditClienteValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/EditClienteValidator"));
const EditCreatePhotoClienteValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/EditCreatePhotoClienteValidator"));
const EditPasswordValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/EditPasswordValidator"));
class ClienteController {
    async store({ request, response }) {
        const payload = await request.validate(CreateClienteValidator_1.default);
        const trx = await Database_1.default.transaction();
        try {
            const user = await User_1.default.create({
                email: payload.email,
                password: payload.password,
                tipo: "cliente"
            });
            const cliente = await Cliente_1.default.create({
                nome: payload.nome,
                telefone: payload.telefone,
                userId: user.id,
                foto: " "
            });
            await trx.commit();
            return response.ok({
                id: cliente.id,
                nome: cliente.nome,
                email: user.email,
                telefone: cliente.telefone
            });
        }
        catch (error) {
            await trx.rollback();
            return response.badRequest("Something in the request is wrong");
        }
    }
    async update({ request, response, auth }) {
        const payload = await request.validate(EditClienteValidator_1.default);
        const userAuth = await auth.use("api").authenticate();
        const trx = await Database_1.default.transaction();
        try {
            const user = await User_1.default.findByOrFail("id", userAuth.id);
            const cliente = await Cliente_1.default.findByOrFail("user_id", userAuth.id);
            if (payload.password) {
                user.merge({
                    email: payload.email,
                    password: payload.password
                });
            }
            else {
                user.merge({
                    email: payload.email,
                });
            }
            await user.save();
            cliente.merge({
                nome: payload.nome,
                telefone: payload.telefone,
            });
            await cliente.save();
            await trx.commit();
            return response.ok({
                id: cliente.id,
                nome: cliente.nome,
                email: user.email,
                telefone: cliente.telefone
            });
        }
        catch (error) {
            await trx.rollback();
            return response.badRequest("Something in the request is wrong");
        }
    }
    async updatePhoto({ request, response, auth }) {
        const payload = await request.validate(EditCreatePhotoClienteValidator_1.default);
        const userAuth = await auth.use("api").authenticate();
        try {
            const cliente = await Cliente_1.default.findByOrFail("user_id", userAuth.id);
            cliente.merge({
                foto: payload.foto
            });
            await cliente.save();
            return response.ok({
                id: cliente.id,
                foto: cliente.foto
            });
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
    async updatePassword({ request, response, auth }) {
        const payload = await request.validate(EditPasswordValidator_1.default);
        const userAuth = await auth.use("api").authenticate();
        try {
            const user = await User_1.default.findByOrFail("id", userAuth.id);
            if (payload.password) {
                user.merge({
                    password: payload.password
                });
            }
            await user.save();
            return response.ok(true);
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
    async resetPassword({ request, response }) {
        const payload = await request.validate(EditPasswordValidator_1.default);
        try {
            const user = await User_1.default.findByOrFail("email", request.input("email"));
            if (payload.password) {
                user.merge({
                    password: payload.password
                });
            }
            await user.save();
            return response.ok(true);
        }
        catch (error) {
            return response.badRequest("Something in the request is wrong");
        }
    }
    async show({ params, response }) {
        const id = params.id;
        const pedido = await Cliente_1.default.query()
            .where("id", id)
            .preload("usuario")
            .preload("endereco", (cityQuery) => {
            cityQuery
                .preload("cidade", (stateQuery) => {
                stateQuery
                    .preload("estado");
            });
        })
            .orderBy("id", "desc")
            .first();
        if (pedido == null) {
            return response.notFound("NÃ£o encontrado");
        }
        return response.ok(pedido);
    }
}
exports.default = ClienteController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xpZW50ZUNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDbGllbnRlQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLDJGQUFrRDtBQUNsRCx1RkFBeUM7QUFDekMsaUZBQW1DO0FBQ25DLHlIQUEyRTtBQUMzRSxxSEFBdUU7QUFDdkUsMklBQTZGO0FBQzdGLHVIQUF5RTtBQUV6RSxNQUFxQixpQkFBaUI7SUFDM0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQXVCO1FBQ3pELE1BQU0sT0FBTyxHQUFHLE1BQU0sT0FBTyxDQUFDLFFBQVEsQ0FBQyxnQ0FBc0IsQ0FBQyxDQUFDO1FBRS9ELE1BQU0sR0FBRyxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN6QyxJQUFJO1lBQ0EsTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFJLENBQUMsTUFBTSxDQUFDO2dCQUMzQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7Z0JBQ3BCLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtnQkFDMUIsSUFBSSxFQUFFLFNBQVM7YUFDbEIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxPQUFPLEdBQUcsTUFBTSxpQkFBTyxDQUFDLE1BQU0sQ0FBQztnQkFDakMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO2dCQUNsQixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7Z0JBQzFCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDZixJQUFJLEVBQUMsR0FBRzthQUNYLENBQUMsQ0FBQztZQUVILE1BQU0sR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBRW5CLE9BQU8sUUFBUSxDQUFDLEVBQUUsQ0FBQztnQkFDZixFQUFFLEVBQUUsT0FBTyxDQUFDLEVBQUU7Z0JBQ2QsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO2dCQUNsQixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7Z0JBQ2pC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Y2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEh0dHBDb250ZXh0Q29udHJhY3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0J1xuaW1wb3J0IERhdGFiYXNlIGZyb20gJ0Bpb2M6QWRvbmlzL0x1Y2lkL0RhdGFiYXNlJztcbmltcG9ydCBDbGllbnRlIGZyb20gJ0FwcC9Nb2RlbHMvQ2xpZW50ZSc7XG5pbXBvcnQgVXNlciBmcm9tICdBcHAvTW9kZWxzL1VzZXInO1xuaW1wb3J0IENyZWF0ZUNsaWVudGVWYWxpZGF0b3IgZnJvbSAnQXBwL1ZhbGlkYXRvcnMvQ3JlYXRlQ2xpZW50ZVZhbGlkYXRvcic7XG5pbXBvcnQgRWRpdENsaWVudGVWYWxpZGF0b3IgZnJvbSAnQXBwL1ZhbGlkYXRvcnMvRWRpdENsaWVudGVWYWxpZGF0b3InO1xuaW1wb3J0IEVkaXRDcmVhdGVQaG90b0NsaWVudGVWYWxpZGF0b3IgZnJvbSAnQXBwL1ZhbGlkYXRvcnMvRWRpdENyZWF0ZVBob3RvQ2xpZW50ZVZhbGlkYXRvcic7XG5pbXBvcnQgRWRpdFBhc3N3b3JkVmFsaWRhdG9yIGZyb20gJ0FwcC9WYWxpZGF0b3JzL0VkaXRQYXNzd29yZFZhbGlkYXRvcic7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENsaWVudGVDb250cm9sbGVyIHtcbiAgICBwdWJsaWMgYXN5bmMgc3RvcmUoeyByZXF1ZXN0LCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKENyZWF0ZUNsaWVudGVWYWxpZGF0b3IpO1xuXG4gICAgICAgIGNvbnN0IHRyeCA9IGF3YWl0IERhdGFiYXNlLnRyYW5zYWN0aW9uKCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5jcmVhdGUoe1xuICAgICAgICAgICAgICAgIGVtYWlsOiBwYXlsb2FkLmVtYWlsLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwYXlsb2FkLnBhc3N3b3JkLFxuICAgICAgICAgICAgICAgIHRpcG86IFwiY2xpZW50ZVwiXG4gICAgICAgICAgICB9KTtcbiAgICBcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudGUgPSBhd2FpdCBDbGllbnRlLmNyZWF0ZSh7XG4gICAgICAgICAgICAgICAgbm9tZTogcGF5bG9hZC5ub21lLFxuICAgICAgICAgICAgICAgIHRlbGVmb25lOiBwYXlsb2FkLnRlbGVmb25lLFxuICAgICAgICAgICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgICAgICAgICBmb3RvOlwiIFwiXG4gICAgICAgICAgICB9KTtcbiAgICBcbiAgICAgICAgICAgIGF3YWl0IHRyeC5jb21taXQoKTtcbiAgICBcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayh7XG4gICAgICAgICAgICAgICAgaWQ6IGNsaWVudGUuaWQsXG4gICAgICAgICAgICAgICAgbm9tZTogY2xpZW50ZS5ub21lLFxuICAgICAgICAgICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICAgICAgICAgIHRlbGVmb25lOiBjbGllbnRlLnRlbGVmb25lXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGF3YWl0IHRyeC5yb2xsYmFjaygpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoXCJTb21ldGhpbmcgaW4gdGhlIHJlcXVlc3QgaXMgd3JvbmdcIik7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIFxuXG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyB1cGRhdGUoeyByZXF1ZXN0LCByZXNwb25zZSwgYXV0aCB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKEVkaXRDbGllbnRlVmFsaWRhdG9yKTtcbiAgICAgICAgY29uc3QgdXNlckF1dGggPSBhd2FpdCBhdXRoLnVzZShcImFwaVwiKS5hdXRoZW50aWNhdGUoKTtcblxuICAgICAgICBjb25zdCB0cnggPSBhd2FpdCBEYXRhYmFzZS50cmFuc2FjdGlvbigpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5T3JGYWlsKFwiaWRcIiwgdXNlckF1dGguaWQpO1xuICAgICAgICAgICAgY29uc3QgY2xpZW50ZSA9IGF3YWl0IENsaWVudGUuZmluZEJ5T3JGYWlsKFwidXNlcl9pZFwiLCB1c2VyQXV0aC5pZCk7XG5cbiAgICAgICAgICAgIGlmIChwYXlsb2FkLnBhc3N3b3JkKSB7XG4gICAgICAgICAgICAgICAgdXNlci5tZXJnZSh7XG4gICAgICAgICAgICAgICAgICAgIGVtYWlsOiBwYXlsb2FkLmVtYWlsLFxuICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogcGF5bG9hZC5wYXNzd29yZFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdXNlci5tZXJnZSh7XG4gICAgICAgICAgICAgICAgICAgIGVtYWlsOiBwYXlsb2FkLmVtYWlsLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCB1c2VyLnNhdmUoKTtcblxuICAgICAgICAgICAgY2xpZW50ZS5tZXJnZSh7XG4gICAgICAgICAgICAgICAgbm9tZTogcGF5bG9hZC5ub21lLFxuICAgICAgICAgICAgICAgIHRlbGVmb25lOiBwYXlsb2FkLnRlbGVmb25lLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IGNsaWVudGUuc2F2ZSgpO1xuXG4gICAgICAgICAgICBhd2FpdCB0cnguY29tbWl0KCk7XG5cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayh7XG4gICAgICAgICAgICBpZDpjbGllbnRlLmlkLFxuICAgICAgICAgICAgbm9tZTpjbGllbnRlLm5vbWUsXG4gICAgICAgICAgICBlbWFpbDp1c2VyLmVtYWlsLFxuICAgICAgICAgICAgdGVsZWZvbmU6IGNsaWVudGUudGVsZWZvbmVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGF3YWl0IHRyeC5yb2xsYmFjaygpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoXCJTb21ldGhpbmcgaW4gdGhlIHJlcXVlc3QgaXMgd3JvbmdcIik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgdXBkYXRlUGhvdG8oeyByZXF1ZXN0LCByZXNwb25zZSwgYXV0aCB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKEVkaXRDcmVhdGVQaG90b0NsaWVudGVWYWxpZGF0b3IpO1xuICAgICAgICBjb25zdCB1c2VyQXV0aCA9IGF3YWl0IGF1dGgudXNlKFwiYXBpXCIpLmF1dGhlbnRpY2F0ZSgpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjbGllbnRlID0gYXdhaXQgQ2xpZW50ZS5maW5kQnlPckZhaWwoXCJ1c2VyX2lkXCIsIHVzZXJBdXRoLmlkKTtcblxuICAgICAgICAgICAgY2xpZW50ZS5tZXJnZSh7XG4gICAgICAgICAgICAgICAgZm90bzogcGF5bG9hZC5mb3RvXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXdhaXQgY2xpZW50ZS5zYXZlKCk7XG5cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayh7XG4gICAgICAgICAgICBpZDpjbGllbnRlLmlkLFxuICAgICAgICAgICAgZm90bzpjbGllbnRlLmZvdG9cbiAgICAgICAgfSk7XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KFwiU29tZXRoaW5nIGluIHRoZSByZXF1ZXN0IGlzIHdyb25nXCIpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgdXBkYXRlUGFzc3dvcmQoeyByZXF1ZXN0LCByZXNwb25zZSwgYXV0aCB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKEVkaXRQYXNzd29yZFZhbGlkYXRvcik7XG4gICAgICAgIGNvbnN0IHVzZXJBdXRoID0gYXdhaXQgYXV0aC51c2UoXCJhcGlcIikuYXV0aGVudGljYXRlKCk7XG5cbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5T3JGYWlsKFwiaWRcIiwgdXNlckF1dGguaWQpO1xuICAgICAgICAgICAgaWYgKHBheWxvYWQucGFzc3dvcmQpIHtcbiAgICAgICAgICAgICAgICB1c2VyLm1lcmdlKHtcbiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHBheWxvYWQucGFzc3dvcmRcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XG5cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHRydWUpO1xuXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuYmFkUmVxdWVzdChcIlNvbWV0aGluZyBpbiB0aGUgcmVxdWVzdCBpcyB3cm9uZ1wiKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlc2V0UGFzc3dvcmQoeyByZXF1ZXN0LCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKEVkaXRQYXNzd29yZFZhbGlkYXRvcik7XG5cbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5T3JGYWlsKFwiZW1haWxcIiwgcmVxdWVzdC5pbnB1dChcImVtYWlsXCIpKTtcbiAgICAgICAgICAgIGlmIChwYXlsb2FkLnBhc3N3b3JkKSB7XG4gICAgICAgICAgICAgICAgdXNlci5tZXJnZSh7XG4gICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwYXlsb2FkLnBhc3N3b3JkXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuXG5cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5vayh0cnVlKTtcblxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoXCJTb21ldGhpbmcgaW4gdGhlIHJlcXVlc3QgaXMgd3JvbmdcIik7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzaG93KHsgcGFyYW1zLCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgICAgIGNvbnN0IGlkID0gcGFyYW1zLmlkO1xuXG4gICAgICAgIGNvbnN0IHBlZGlkbyA9IGF3YWl0IENsaWVudGUucXVlcnkoKVxuICAgICAgICAgICAgLndoZXJlKFwiaWRcIiwgaWQpXG4gICAgICAgICAgICAucHJlbG9hZChcInVzdWFyaW9cIilcbiAgICAgICAgICAgICAgICAucHJlbG9hZChcImVuZGVyZWNvXCIsKGNpdHlRdWVyeSk9PntcbiAgICAgICAgICAgICAgICAgICAgY2l0eVF1ZXJ5XG4gICAgICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiY2lkYWRlXCIsKHN0YXRlUXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlUXVlcnlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5wcmVsb2FkKFwiZXN0YWRvXCIpXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vcmRlckJ5KFwiaWRcIiwgXCJkZXNjXCIpXG4gICAgICAgICAgICAuZmlyc3QoKTtcblxuICAgICAgICBpZiAocGVkaWRvID09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5ub3RGb3VuZChcIk7Do28gZW5jb250cmFkb1wiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzcG9uc2Uub2socGVkaWRvKTtcbiAgICB9XG59Il19